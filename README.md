# ðŸ¦… Ansury Systems - AI Sales Engine

Ansury is a multi-tenant, portable AI sales widget designed for high-ticket service businesses. It transforms anonymous traffic into qualified leads using Gemini 3 Flash.

---

## ðŸ›  Database Architecture (Supabase)

Run this script in your **Supabase SQL Editor** to initialize the brain of the system:

```sql
-- 1. Enable UUID Extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- 2. Clients (Branding & AI Config)
CREATE TABLE clients (
    id TEXT PRIMARY KEY, 
    user_id UUID REFERENCES auth.users(id),
    name TEXT NOT NULL,
    primary_color TEXT DEFAULT '#4F46E5',
    greeting TEXT DEFAULT 'Welcome! How can we help?',
    system_instruction TEXT DEFAULT 'You are a professional luxury sales agent.',
    authorized_origins TEXT[] DEFAULT ARRAY['*'],
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 3. Leads (The Output)
CREATE TABLE leads (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    client_id TEXT REFERENCES clients(id) ON DELETE CASCADE,
    name TEXT NOT NULL,
    email TEXT NOT NULL,
    phone TEXT,
    chat_transcript JSONB,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. Security (RLS)
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users manage their own clients" ON clients FOR ALL USING (auth.uid() = user_id);
CREATE POLICY "Public select client config" ON clients FOR SELECT USING (true);
CREATE POLICY "Public insert leads" ON leads FOR INSERT WITH CHECK (true);

-- 5. Realtime Sync
ALTER PUBLICATION supabase_realtime ADD TABLE clients;
```

---

## â˜ï¸ Cloudflare Deployment Guide

### 1. The Dashboard & API (Cloudflare Pages)
*   Connect your GitHub repo to **Cloudflare Pages**.
*   **Environment Variables**:
    *   `API_KEY`: Your Gemini Key.
    *   `NEXT_PUBLIC_SUPABASE_URL`: From Supabase.
    *   `NEXT_PUBLIC_SUPABASE_ANON_KEY`: From Supabase.
*   **Build Command**: `npm run build`
*   **Build Directory**: `dist`

### 2. The Widget Asset (Cloudflare R2)
*   Create an R2 Bucket named `ansury-assets`.
*   Upload the bundled `ansury-widget.umd.js` (generated by `vite.config.ts`).
*   Enable a **Public Domain** for the bucket (e.g., `assets.ansury.systems`).

### 3. The Smart Loader (Cloudflare Workers)
Deploy a Worker to handle the `loader.js` dynamically. This allows you to version-control the loader without asking clients to update their script tags.

```javascript
// Cloudflare Worker Example
export default {
  async fetch(request, env) {
    const url = new URL(request.url);
    if (url.pathname === "/loader.js") {
      const loaderScript = `
        (function() {
          const clientId = document.currentScript.getAttribute('data-client-id');
          const container = document.createElement('div');
          container.id = 'ansury-root';
          document.body.appendChild(container);
          const shadow = container.attachShadow({ mode: 'open' });
          const script = document.createElement('script');
          script.src = "https://assets.ansury.systems/ansury-widget.umd.js";
          script.onload = () => {
            window.AnsuryWidget.init(shadow, clientId);
          };
          shadow.appendChild(script);
        })();
      `;
      return new Response(loaderScript, {
        headers: { "content-type": "application/javascript" },
      });
    }
    return new Response("Not Found", { status: 404 });
  }
};
```

---

## ðŸš€ Client Implementation
Once deployed, your clients simply paste this:

```html
<script 
  src="https://your-worker.workers.dev/loader.js" 
  data-client-id="client-slug-123" 
  async
></script>
```

---

*Architect: Senior Full-Stack Engineer | Ansury Systems Â© 2025*
